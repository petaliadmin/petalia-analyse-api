version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: agritech_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-agritech_user}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-agritech_password}
      MONGO_INITDB_DATABASE: agritech
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - agritech-network

  # NestJS Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agritech_backend
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      MONGODB_URI: mongodb://mongodb:27017/agritech
      MONGODB_USER: ${MONGODB_USER:-agritech_user}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-agritech_password}
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      AI_DISEASE_DETECTION_URL: ${AI_DISEASE_DETECTION_URL:-http://ai-disease:8001}
      AI_SOIL_ANALYSIS_URL: ${AI_SOIL_ANALYSIS_URL:-http://ai-soil:8002}
      AI_ASSISTANT_URL: ${AI_ASSISTANT_URL:-http://ai-assistant:8003}
    volumes:
      - ./uploads:/app/uploads
      - ./src:/app/src # Hot reload en développement
    depends_on:
      - mongodb
    networks:
      - agritech-network

  # AI Service - Disease Detection (Python FastAPI)
  # À remplacer par le vrai service IA
  ai-disease:
    image: placeholder/ai-disease:latest
    container_name: agritech_ai_disease
    restart: unless-stopped
    ports:
      - "8001:8001"
    networks:
      - agritech-network
    # Sera remplacé par le service Python réel

  # AI Service - Soil Analysis (Python FastAPI)
  ai-soil:
    image: placeholder/ai-soil:latest
    container_name: agritech_ai_soil
    restart: unless-stopped
    ports:
      - "8002:8002"
    networks:
      - agritech-network
    # Sera remplacé par le service Python réel

  # AI Service - Assistant (Python FastAPI)
  ai-assistant:
    image: placeholder/ai-assistant:latest
    container_name: agritech_ai_assistant
    restart: unless-stopped
    ports:
      - "8003:8003"
    networks:
      - agritech-network
    # Sera remplacé par le service Python réel

  # Mongo Express (Admin UI pour MongoDB - optionnel)
  mongo-express:
    image: mongo-express:1.0
    container_name: agritech_mongo_express
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGODB_USER:-agritech_user}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGODB_PASSWORD:-agritech_password}
      ME_CONFIG_MONGODB_URL: mongodb://${MONGODB_USER:-agritech_user}:${MONGODB_PASSWORD:-agritech_password}@mongodb:27017/
      ME_CONFIG_BASICAUTH: false
    depends_on:
      - mongodb
    networks:
      - agritech-network

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  agritech-network:
    driver: bridge
